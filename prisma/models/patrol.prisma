// Voice patrol settings now live in GuildSettings (patrolBotuserRoleId, patrolChannelCategoryId)

model VoicePatrolTime {
  id        Int      @id @default(autoincrement())
  guildId   String
  userId    String // Discord User ID
  user      User     @relation(fields: [userId], references: [discordId])
  totalMs   BigInt   @default(0)
  channelId String? // Channel ID where the hours were accumulated (for logging)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([guildId, userId], map: "VoicePatrolTime_guild_user_unique")
  @@index([guildId], map: "VoicePatrolTime_guild_idx")
  @@index([userId], map: "VoicePatrolTime_user_idx")
}

/// Aggregated monthly totals (UTC) for voice patrol time.
model VoicePatrolMonthlyTime {
  id        Int      @id @default(autoincrement())
  guildId   String
  userId    String
  user      User     @relation(fields: [userId], references: [discordId])
  year      Int // UTC year
  month     Int // 1-12, UTC month
  totalMs   BigInt   @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([guildId, userId, year, month], map: "VoicePatrolMonthlyTime_guild_user_year_month_unique")
  @@index([guildId, year, month], map: "VoicePatrolMonthlyTime_guild_year_month_idx")
  @@index([userId], map: "VoicePatrolMonthlyTime_user_idx")
}

/// Active voice patrol sessions for persistence across restarts
model ActiveVoicePatrolSession {
  id        Int      @id @default(autoincrement())
  guildId   String
  userId    String
  channelId String
  startedAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([guildId, userId], map: "ActiveVoicePatrolSession_guild_user_unique")
  @@index([guildId], map: "ActiveVoicePatrolSession_guild_idx")
}

/// Track users who have received promotion notifications
model VoicePatrolPromotion {
  id         Int      @id @default(autoincrement())
  guildId    String
  userId     String // Discord User ID → User.discordId
  user       User     @relation(fields: [userId], references: [discordId])
  totalHours Float
  notifiedAt DateTime @default(now())

  @@unique([guildId, userId], map: "VoicePatrolPromotion_guild_user_unique")
  @@index([guildId], map: "VoicePatrolPromotion_guild_idx")
  @@index([userId], map: "VoicePatrolPromotion_user_idx")
}

/// Track promotion notifications per (user, next rank) to avoid duplicate pings
model VoicePatrolPromotionNotification {
  id                 Int       @id @default(autoincrement())
  guildId            String
  userId             String // Discord User ID → User.discordId
  user               User      @relation(fields: [userId], references: [discordId])
  nextRankRoleId     String
  totalHoursAtNotify Float?
  notifiedAt         DateTime  @default(now())

  @@unique([guildId, userId, nextRankRoleId], map: "VoicePatrolPromotionNotification_guild_user_next_rank_unique")
  @@index([guildId], map: "VoicePatrolPromotionNotification_guild_idx")
  @@index([userId], map: "VoicePatrolPromotionNotification_user_idx")
}
